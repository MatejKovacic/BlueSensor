<html>
<head>
<title>BlueSensor</title>

<style type="text/css">
    table td {
        text-align: right;
    }

    .demo-container {
        box-sizing: border-box;
        width: 1000px;
        height: 400px;
        padding: 20px 15px 15px 15px;
        margin: 15px auto 30px auto;
        border: 1px solid #ddd;
        background: #fff;
        background: linear-gradient(#f6f6f6 0, #fff 50px);
        background: -o-linear-gradient(#f6f6f6 0, #fff 50px);
        background: -ms-linear-gradient(#f6f6f6 0, #fff 50px);
        background: -moz-linear-gradient(#f6f6f6 0, #fff 50px);
        background: -webkit-linear-gradient(#f6f6f6 0, #fff 50px);
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
        -o-box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        -ms-box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        -moz-box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        -webkit-box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    }

    .demo-graph {
        width: 100%;
        height: 100%;
        font-size: 14px;
        line-height: 1.2em;
    }
</style>

<script language="javascript" type="text/javascript" src="/static/jquery.js"></script>
<script language="javascript" type="text/javascript" src="/static/jquery.flot.js"></script>
<script language="javascript" type="text/javascript" src="/static/jquery.flot.time.js"></script>

<script type="text/javascript">
    $(function () {
        var maxrecords = 300;
        var ds = {
            "gas1":     { label: "Gas 1", color: "#000000",  data: [] },
            "gas2":     { label: "Gas 2", color: "#008000", data: [] },
            "humidity": { label: "Humidity",           color: "#0000ff", data: [] },
            "temp1":    { label: "Temperature 1",   color: "#ffa500", data: [] },
            "temp2":    { label: "Temperature 2",   color: "#ff0000", data: [] },
            "temp3":    { label: "Temperature 3",   color: "#ffff00", data: [] },
            "pm10":     { label: "PM 10",  color: "#0000ff", data: [] },
            "pm25":     { label: "PM 2.5",  color: "#ff0000", data: [] }
        };

        var choiceContainer = $("#choices");
        for (var key in ds) {
            choiceContainer.append("<br><input type='checkbox' name='" +
                key + "' checked='checked' id='id_" + key + "' style='display:none; font-size: small;'></input>" +
                "<label for='id_" + key + "' id='lb_" + key + "' style='display:none; font-size: small;'>" +
                ds[key].label + "</label>");
        }

        $("#title").html("BlueSensor (<i>waiting for data from USB...</i>)");

        wsock = new WebSocket("ws://" + document.location.host + "/data");
        wsock.onmessage = function (event) {
            var rs = JSON.parse(event.data);

            for (var dkey in ds) {
                $("#id_" + dkey).hide();
                $("#lb_" + dkey).hide();
            }

            var skey = "metadata";
            if (skey in rs) {
                rm = rs[skey];
                skey = "sensors";
                if (skey in rm) {
                    rms = rm[skey];
                    for (var dkey in rms) {
                        if (!ds[dkey]) {
                            ds[dkey] = { label: dkey, color: "#000000", data: [] };
                        }
                        ds[dkey].label = rms[dkey][0];
                        ds[dkey].color = rms[dkey][3];
                        $("#id_" + dkey).show();
                        $("#lb_" + dkey).show();
                    }
                }

                skey = "device_name";
                if (skey in rm) {
                    var titl = rm[skey];
                    skey = "device_location";
                    if (skey in rm) {
                        titl = titl + " (" + rm[skey] + ")";
                    }
                    $("#title").html(titl);
                }
            }

            skey = "time";
            if (skey in rs) { t = rs[skey]; }
            else { t = Date.now(); }

            skey = "data";
            if (skey in rs) {
                rd = rs[skey];
                for (var dkey in rd) {
                    if (!ds[dkey]) {
                        ds[dkey] = { label: dkey, color: "#000000", data: [] };
                    }
                    ds[dkey].data.push([t, rd[dkey][0]]);
                    if (ds[dkey].data.length > maxrecords) {
                        ds[dkey].data = ds[dkey].data.slice(ds[dkey].data.length - maxrecords, ds[dkey].data.length);
                    }
                }
            }

            drawGraph();
        };

        drawGraph = function () {
            var disp = [];

            choiceContainer.find("input:checked").each(function () {
                if ($(this).is(":visible")) {
                    var key = $(this).attr("name");
                    if (key && ds[key]) {
                        disp.push(ds[key]);
                    }
                }
            });

            $.plot("#graf", disp, {
                lines: { show: true},
                xaxis: { mode: "time", minTickSize: [1, "second"] }
            });
        };
    });
</script>
</head>
<body>
<h1 id="title" style="color: #993300; text-align: center; font-family:verdana;">
BlueSensor initialisation...
</h1>
<div class="demo-container">
    <div id="graf" class="demo-graph" style="float:left; width:85%;"></div>
    <p id="choices" style="float:right; width:15%;"></p>
</div>

</body>
</html>
